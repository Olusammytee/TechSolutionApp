/**
 * ğŸ§ª ORDER SELECTOR TEST CLASS - Mastering the Selector Pattern!
 *
 * Welcome to data access layer testing! Learn professional SOQL patterns.
 *
 * ğŸ¯ WHAT YOU'LL LEARN:
 * âœ… How to test the Selector pattern (data access layer)
 * âœ… How to verify SOQL queries return correct data
 * âœ… How to test WITH SECURITY_ENFORCED
 * âœ… How to test aggregation queries
 * âœ… How to test relationship queries
 *
 * ğŸ“š TESTING CONCEPTS COVERED:
 * - Selector pattern testing
 * - Test data setup for complex queries
 * - Aggregate result testing
 * - Security enforcement validation
 * - Query optimization verification
 *
 * ğŸ“ EDUCATIONAL GOAL: 95%+ code coverage with realistic data scenarios
 *
 * @author TechSolutionApp Educational Platform
 * @date 2025
 */
@isTest
private class OrderSelectorTest {

    /**
     * ğŸ—ï¸ TEST SETUP: Create comprehensive test data
     *
     * Why comprehensive setup?
     * - Selector methods need realistic data to query
     * - We need multiple customers, devices, orders for testing
     * - Data relationships must be established
     */
    @TestSetup
    static void setupTestData() {
        // Create Customers
        List<Customer__c> customers = new List<Customer__c>();
        customers.add(new Customer__c(
            Name = 'Acme Corporation',
            Email__c = 'contact@acme.com',
            Phone__c = '555-0001',
            Customer_Type__c = 'Business'
        ));
        customers.add(new Customer__c(
            Name = 'Global Tech Inc',
            Email__c = 'info@globaltech.com',
            Phone__c = '555-0002',
            Customer_Type__c = 'Business'
        ));
        customers.add(new Customer__c(
            Name = 'John Smith',
            Email__c = 'john@email.com',
            Phone__c = '555-0003',
            Customer_Type__c = 'Individual'
        ));
        insert customers;

        // Create Devices
        List<Device__c> devices = new List<Device__c>();
        devices.add(new Device__c(
            Name = 'MacBook Pro 16"',
            Type__c = 'Laptop',
            Price__c = 2500.00,
            Cost_Price__c = 1800.00,
            Stock_Quantity__c = 50
        ));
        devices.add(new Device__c(
            Name = 'iPhone 15 Pro',
            Type__c = 'Smartphone',
            Price__c = 1199.00,
            Cost_Price__c = 850.00,
            Stock_Quantity__c = 100
        ));
        devices.add(new Device__c(
            Name = 'iPad Pro 12.9"',
            Type__c = 'Tablet',
            Price__c = 1099.00,
            Cost_Price__c = 750.00,
            Stock_Quantity__c = 75
        ));
        insert devices;

        // Create Orders with various statuses and priorities
        List<Order__c> orders = new List<Order__c>();

        // Order 1: High priority, pending
        orders.add(new Order__c(
            Customer__c = customers[0].Id,
            Order_Date__c = Date.today(),
            Order_Status__c = 'Pending',
            Priority__c = 'High',
            Subtotal__c = 5000.00,
            Tax_Amount__c = 500.00,
            Total_Amount__c = 5500.00
        ));

        // Order 2: Critical priority, confirmed
        orders.add(new Order__c(
            Customer__c = customers[1].Id,
            Order_Date__c = Date.today().addDays(-1),
            Order_Status__c = 'Confirmed',
            Priority__c = 'Critical',
            Subtotal__c = 3000.00,
            Tax_Amount__c = 300.00,
            Total_Amount__c = 3300.00
        ));

        // Order 3: Normal priority, delivered (completed)
        orders.add(new Order__c(
            Customer__c = customers[2].Id,
            Order_Date__c = Date.today().addDays(-7),
            Order_Status__c = 'Delivered',
            Priority__c = 'Normal',
            Subtotal__c = 1200.00,
            Tax_Amount__c = 120.00,
            Total_Amount__c = 1320.00
        ));

        // Order 4: Low priority, cancelled
        orders.add(new Order__c(
            Customer__c = customers[0].Id,
            Order_Date__c = Date.today().addDays(-3),
            Order_Status__c = 'Cancelled',
            Priority__c = 'Low',
            Subtotal__c = 800.00,
            Tax_Amount__c = 80.00,
            Total_Amount__c = 880.00
        ));

        insert orders;

        // Create Order Line Items
        List<Order_Line_Item__c> lineItems = new List<Order_Line_Item__c>();

        // Line items for Order 1
        lineItems.add(new Order_Line_Item__c(
            Order__c = orders[0].Id,
            Device__c = devices[0].Id,
            Product_Name__c = 'MacBook Pro 16"',
            Quantity__c = 2,
            Unit_Price__c = 2500.00,
            Line_Total__c = 5000.00
        ));

        // Line items for Order 2
        lineItems.add(new Order_Line_Item__c(
            Order__c = orders[1].Id,
            Device__c = devices[1].Id,
            Product_Name__c = 'iPhone 15 Pro',
            Quantity__c = 2,
            Unit_Price__c = 1199.00,
            Line_Total__c = 2398.00
        ));
        lineItems.add(new Order_Line_Item__c(
            Order__c = orders[1].Id,
            Device__c = devices[2].Id,
            Product_Name__c = 'iPad Pro 12.9"',
            Quantity__c = 1,
            Unit_Price__c = 1099.00,
            Line_Total__c = 1099.00
        ));

        // Line items for Order 3
        lineItems.add(new Order_Line_Item__c(
            Order__c = orders[2].Id,
            Device__c = devices[1].Id,
            Product_Name__c = 'iPhone 15 Pro',
            Quantity__c = 1,
            Unit_Price__c = 1199.00,
            Line_Total__c = 1199.00
        ));

        insert lineItems;
    }

    /**
     * ğŸ§ª TEST 1: Select By ID
     *
     * WHAT THIS TESTS:
     * - Basic order retrieval by ID
     * - Field population
     * - WITH SECURITY_ENFORCED compliance
     */
    @isTest
    static void testSelectById() {
        // ğŸ“ ARRANGE
        List<Order__c> allOrders = [SELECT Id FROM Order__c LIMIT 2];
        Set<Id> orderIds = new Set<Id>();
        for (Order__c order : allOrders) {
            orderIds.add(order.Id);
        }

        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> selectedOrders = OrderSelector.selectById(orderIds);
        Test.stopTest();

        // âœ… ASSERT
        System.assertEquals(2, selectedOrders.size(),
            'ğŸ“Š Should return 2 orders');

        // Verify fields are populated
        for (Order__c order : selectedOrders) {
            System.assertNotEquals(null, order.Id,
                'âœ… Id should be populated');
            System.assertNotEquals(null, order.Name,
                'âœ… Name should be populated');
            System.assertNotEquals(null, order.Order_Status__c,
                'âœ… Order_Status__c should be populated');
        }
    }

    /**
     * ğŸ§ª TEST 2: Select By ID - Empty Set
     *
     * WHAT THIS TESTS:
     * - Handling empty ID sets
     * - No errors with empty input
     * - Returns empty list
     */
    @isTest
    static void testSelectByIdEmpty() {
        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectById(new Set<Id>());
        Test.stopTest();

        // âœ… ASSERT
        System.assertNotEquals(null, orders,
            'ğŸ“Š Should return empty list, not null');
        System.assertEquals(0, orders.size(),
            'âœ… Empty set should return empty list');
    }

    /**
     * ğŸ§ª TEST 3: Select By ID - Null Set
     *
     * WHAT THIS TESTS:
     * - Defensive programming
     * - Null parameter handling
     * - No null pointer exceptions
     */
    @isTest
    static void testSelectByIdNull() {
        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectById(null);
        Test.stopTest();

        // âœ… ASSERT
        System.assertNotEquals(null, orders,
            'ğŸ“Š Null input should return empty list');
        System.assertEquals(0, orders.size(),
            'âœ… Null set should be handled gracefully');
    }

    /**
     * ğŸ§ª TEST 4: Select Financial By ID
     *
     * WHAT THIS TESTS:
     * - Financial field retrieval
     * - Subtotal, tax, total amount fields
     * - More comprehensive field set
     */
    @isTest
    static void testSelectFinancialById() {
        // ğŸ“ ARRANGE
        List<Order__c> allOrders = [SELECT Id FROM Order__c LIMIT 1];
        Set<Id> orderIds = new Set<Id>{allOrders[0].Id};

        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectFinancialById(orderIds);
        Test.stopTest();

        // âœ… ASSERT
        System.assertEquals(1, orders.size(),
            'ğŸ“Š Should return 1 order');

        Order__c order = orders[0];
        System.assertNotEquals(null, order.Subtotal__c,
            'ğŸ’° Subtotal__c should be populated');
        System.assertNotEquals(null, order.Tax_Amount__c,
            'ğŸ’° Tax_Amount__c should be populated');
        System.assertNotEquals(null, order.Total_Amount__c,
            'ğŸ’° Total_Amount__c should be populated');
    }

    /**
     * ğŸ§ª TEST 5: Select By Customer
     *
     * WHAT THIS TESTS:
     * - Filtering orders by customer
     * - Relationship queries
     * - Multiple orders per customer
     */
    @isTest
    static void testSelectByCustomer() {
        // ğŸ“ ARRANGE
        Customer__c customer = [SELECT Id FROM Customer__c WHERE Name = 'Acme Corporation' LIMIT 1];
        Set<Id> customerIds = new Set<Id>{customer.Id};

        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectByCustomer(customerIds);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(orders.size() > 0,
            'ğŸ“Š Acme Corporation should have orders');

        // Verify all orders belong to correct customer
        for (Order__c order : orders) {
            System.assertEquals(customer.Id, order.Customer__c,
                'âœ… All orders should belong to Acme Corporation');
            System.assertNotEquals(null, order.Order_Date__c,
                'ğŸ“… Order date should be populated');
        }
    }

    /**
     * ğŸ§ª TEST 6: Select For Dashboard
     *
     * WHAT THIS TESTS:
     * - Date range filtering
     * - Dashboard-specific fields
     * - Date-based queries
     */
    @isTest
    static void testSelectForDashboard() {
        // ğŸ“ ARRANGE
        Date startDate = Date.today().addDays(-30);
        Date endDate = Date.today();

        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectForDashboard(startDate, endDate);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(orders.size() > 0,
            'ğŸ“Š Should find orders in date range');

        // Verify all orders are within date range
        for (Order__c order : orders) {
            System.assert(order.Order_Date__c >= startDate,
                'âœ… Order date should be >= start date');
            System.assert(order.Order_Date__c <= endDate,
                'âœ… Order date should be <= end date');
        }
    }

    /**
     * ğŸ§ª TEST 7: Select High Priority
     *
     * WHAT THIS TESTS:
     * - Priority filtering
     * - Status filtering (excludes completed/cancelled)
     * - Multiple filter conditions
     */
    @isTest
    static void testSelectHighPriority() {
        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectHighPriority();
        Test.stopTest();

        // âœ… ASSERT
        System.assert(orders.size() > 0,
            'ğŸ“Š Should have high priority orders');

        // Verify all orders are high or critical priority
        for (Order__c order : orders) {
            System.assert(
                order.Priority__c == 'High' || order.Priority__c == 'Critical',
                'âš¡ Order should be High or Critical priority');

            System.assert(
                order.Order_Status__c != 'Delivered' &&
                order.Order_Status__c != 'Cancelled',
                'âœ… Should exclude completed/cancelled orders');
        }
    }

    /**
     * ğŸ§ª TEST 8: Select Pending Orders
     *
     * WHAT THIS TESTS:
     * - Status-based filtering
     * - Workflow-specific queries
     * - Pending and Confirmed orders
     */
    @isTest
    static void testSelectPending() {
        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectPending();
        Test.stopTest();

        // âœ… ASSERT
        System.assert(orders.size() > 0,
            'ğŸ“Š Should have pending orders');

        // Verify all orders are pending or confirmed
        for (Order__c order : orders) {
            System.assert(
                order.Order_Status__c == 'Pending' ||
                order.Order_Status__c == 'Confirmed',
                'âœ… Order should be Pending or Confirmed');
        }
    }

    /**
     * ğŸ§ª TEST 9: Select With Line Items
     *
     * WHAT THIS TESTS:
     * - Parent-child relationship queries
     * - Subquery results
     * - Complete order data retrieval
     */
    @isTest
    static void testSelectWithLineItems() {
        // ğŸ“ ARRANGE
        List<Order__c> allOrders = [SELECT Id FROM Order__c WHERE Id IN (
            SELECT Order__c FROM Order_Line_Item__c
        ) LIMIT 2];
        Set<Id> orderIds = new Set<Id>();
        for (Order__c order : allOrders) {
            orderIds.add(order.Id);
        }

        // ğŸ¬ ACT
        Test.startTest();
        List<Order__c> orders = OrderSelector.selectWithLineItems(orderIds);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(orders.size() > 0,
            'ğŸ“Š Should return orders with line items');

        // Verify line items are included
        Boolean foundLineItems = false;
        for (Order__c order : orders) {
            if (order.Order_Line_Items__r != null && order.Order_Line_Items__r.size() > 0) {
                foundLineItems = true;

                // Verify line item fields
                for (Order_Line_Item__c lineItem : order.Order_Line_Items__r) {
                    System.assertNotEquals(null, lineItem.Product_Name__c,
                        'ğŸ“¦ Line item should have product name');
                    System.assertNotEquals(null, lineItem.Quantity__c,
                        'ğŸ”¢ Line item should have quantity');
                    System.assertNotEquals(null, lineItem.Unit_Price__c,
                        'ğŸ’° Line item should have unit price');
                }
            }
        }

        System.assert(foundLineItems,
            'âœ… At least one order should have line items');
    }

    /**
     * ğŸ§ª TEST 10: Select Line Items By Order
     *
     * WHAT THIS TESTS:
     * - Child record retrieval
     * - Filtering by parent relationship
     * - Line item fields population
     */
    @isTest
    static void testSelectLineItemsByOrder() {
        // ğŸ“ ARRANGE
        List<Order__c> orders = [SELECT Id FROM Order__c LIMIT 2];
        Set<Id> orderIds = new Set<Id>();
        for (Order__c order : orders) {
            orderIds.add(order.Id);
        }

        // ğŸ¬ ACT
        Test.startTest();
        List<Order_Line_Item__c> lineItems =
            OrderSelector.selectLineItemsByOrder(orderIds);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(lineItems.size() > 0,
            'ğŸ“Š Should return line items for orders');

        // Verify line items belong to correct orders
        for (Order_Line_Item__c lineItem : lineItems) {
            System.assert(orderIds.contains(lineItem.Order__c),
                'âœ… Line item should belong to one of the selected orders');
            System.assertNotEquals(null, lineItem.Quantity__c,
                'ğŸ”¢ Quantity should be populated');
        }
    }

    /**
     * ğŸ§ª TEST 11: Select Line Items By Device
     *
     * WHAT THIS TESTS:
     * - Filtering by device (product)
     * - Device-to-order relationship
     * - Order status filtering
     */
    @isTest
    static void testSelectLineItemsByDevice() {
        // ğŸ“ ARRANGE
        List<Device__c> devices = [SELECT Id FROM Device__c LIMIT 1];
        Set<Id> deviceIds = new Set<Id>{devices[0].Id};

        // ğŸ¬ ACT
        Test.startTest();
        List<Order_Line_Item__c> lineItems =
            OrderSelector.selectLineItemsByDevice(deviceIds);
        Test.stopTest();

        // âœ… ASSERT
        // May or may not have line items depending on test data
        // But should not throw errors
        System.assertNotEquals(null, lineItems,
            'ğŸ“Š Should return list (may be empty)');

        // If line items exist, verify they're for correct device
        for (Order_Line_Item__c lineItem : lineItems) {
            System.assertEquals(devices[0].Id, lineItem.Device__c,
                'âœ… Line item should be for the selected device');
        }
    }

    /**
     * ğŸ§ª TEST 12: Get Order Analytics
     *
     * WHAT THIS TESTS:
     * - Aggregate queries
     * - COUNT, SUM, AVG functions
     * - GROUP BY functionality
     */
    @isTest
    static void testGetOrderAnalytics() {
        // ğŸ“ ARRANGE
        Date startDate = Date.today().addDays(-30);
        Date endDate = Date.today();

        // ğŸ¬ ACT
        Test.startTest();
        List<AggregateResult> analytics =
            OrderSelector.getOrderAnalytics(startDate, endDate);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(analytics.size() > 0,
            'ğŸ“Š Should return aggregated analytics');

        // Verify aggregate result structure
        for (AggregateResult result : analytics) {
            System.assertNotEquals(null, result.get('status'),
                'âœ… Status should be in aggregate result');
            System.assertNotEquals(null, result.get('priority'),
                'âœ… Priority should be in aggregate result');
            System.assertNotEquals(null, result.get('orderCount'),
                'ğŸ”¢ Order count should be calculated');
            // Revenue might be null if no orders with amount
            System.debug('ğŸ“Š Aggregate Result: ' + result);
        }
    }

    /**
     * ğŸ§ª TEST 13: Get Customer Order Analytics
     *
     * WHAT THIS TESTS:
     * - Customer-level aggregation
     * - Relationship field grouping
     * - Top customer identification
     */
    @isTest
    static void testGetCustomerOrderAnalytics() {
        // ğŸ“ ARRANGE
        Date startDate = Date.today().addDays(-30);
        Date endDate = Date.today();

        // ğŸ¬ ACT
        Test.startTest();
        List<AggregateResult> analytics =
            OrderSelector.getCustomerOrderAnalytics(startDate, endDate);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(analytics.size() > 0,
            'ğŸ“Š Should return customer analytics');

        // Verify customer aggregate data
        for (AggregateResult result : analytics) {
            System.assertNotEquals(null, result.get('customerId'),
                'âœ… Customer ID should be present');
            System.assertNotEquals(null, result.get('customerName'),
                'âœ… Customer name should be present');
            System.assertNotEquals(null, result.get('orderCount'),
                'ğŸ”¢ Order count should be calculated');
            System.debug('ğŸ‘¥ Customer Analytics: ' + result);
        }
    }

    /**
     * ğŸ§ª TEST 14: Get Daily Order Trends
     *
     * WHAT THIS TESTS:
     * - Time-series data aggregation
     * - Daily grouping
     * - Trend analysis queries
     */
    @isTest
    static void testGetDailyOrderTrends() {
        // ğŸ“ ARRANGE
        Date startDate = Date.today().addDays(-7);
        Date endDate = Date.today();

        // ğŸ¬ ACT
        Test.startTest();
        List<AggregateResult> trends =
            OrderSelector.getDailyOrderTrends(startDate, endDate);
        Test.stopTest();

        // âœ… ASSERT
        System.assert(trends.size() > 0,
            'ğŸ“Š Should return daily trends');

        // Verify trend data structure
        for (AggregateResult result : trends) {
            System.assertNotEquals(null, result.get('orderDate'),
                'ğŸ“… Order date should be present');
            System.assertNotEquals(null, result.get('orderCount'),
                'ğŸ”¢ Daily order count should be calculated');
            System.debug('ğŸ“ˆ Daily Trend: ' + result);
        }
    }

    /**
     * ğŸ§ª TEST 15: Real-World Scenario - Dashboard Data Loading
     *
     * WHAT THIS TESTS:
     * - Complete dashboard workflow
     * - Multiple selector method calls
     * - Realistic data retrieval pattern
     */
    @isTest
    static void testRealWorldDashboardScenario() {
        // ğŸ“ SCENARIO: Loading dashboard with all relevant data
        Date startDate = Date.today().addDays(-30);
        Date endDate = Date.today();

        // ğŸ¬ ACT
        Test.startTest();

        // Step 1: Get high priority orders for action items
        List<Order__c> priorityOrders = OrderSelector.selectHighPriority();

        // Step 2: Get pending orders for workflow
        List<Order__c> pendingOrders = OrderSelector.selectPending();

        // Step 3: Get analytics for charts
        List<AggregateResult> orderAnalytics =
            OrderSelector.getOrderAnalytics(startDate, endDate);

        // Step 4: Get customer analytics for insights
        List<AggregateResult> customerAnalytics =
            OrderSelector.getCustomerOrderAnalytics(startDate, endDate);

        // Step 5: Get daily trends for time-series chart
        List<AggregateResult> dailyTrends =
            OrderSelector.getDailyOrderTrends(startDate, endDate);

        Test.stopTest();

        // âœ… ASSERT
        // Dashboard should have all necessary data
        System.assertNotEquals(null, priorityOrders,
            'ğŸ“Š Priority orders should be loaded');
        System.assertNotEquals(null, pendingOrders,
            'ğŸ“Š Pending orders should be loaded');
        System.assertNotEquals(null, orderAnalytics,
            'ğŸ“Š Order analytics should be loaded');
        System.assertNotEquals(null, customerAnalytics,
            'ğŸ“Š Customer analytics should be loaded');
        System.assertNotEquals(null, dailyTrends,
            'ğŸ“Š Daily trends should be loaded');

        System.debug('ğŸ‰ Dashboard loaded successfully!');
        System.debug('   Priority Orders: ' + priorityOrders.size());
        System.debug('   Pending Orders: ' + pendingOrders.size());
        System.debug('   Analytics Groups: ' + orderAnalytics.size());
        System.debug('   Top Customers: ' + customerAnalytics.size());
        System.debug('   Trend Data Points: ' + dailyTrends.size());
    }
}
