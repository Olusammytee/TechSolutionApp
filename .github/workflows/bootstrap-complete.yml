name: Bootstrap Tech Solutions App (Complete)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      
      - name: Generate Complete SFDX project
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Scaffolding Complete Tech Solutions SFDX app..."

          # Create directory structure
          mkdir -p config
          mkdir -p force-app/main/default/{applications,objects,classes,triggers,lwc,tabs,permissionsets}
          mkdir -p force-app/main/default/objects/Device__c/{fields,listViews}
          mkdir -p force-app/main/default/objects/Device_Order__c/{fields,validationRules}
          mkdir -p force-app/main/default/lwc/{inventoryDashboard,quickOrder}
          mkdir -p scripts/apex

          # Generate all required files using a more compact approach
          ./scripts/generate-project.sh

      - name: Create generation script
        run: |
          cat > scripts/generate-project.sh << 'SCRIPT_EOF'
          #!/bin/bash
          
          # Basic project files
          cat > .gitignore << 'EOF'
          .sfdx/
          .sf/
          .vscode/
          node_modules/
          coverage/
          test-results/
          package-lock.json
          yarn.lock
          EOF

          cat > .forceignore << 'EOF'
          **/tmp/**
          *.log
          .DS_Store
          EOF

          cat > sfdx-project.json << 'EOF'
          {
            "name": "tech-solutions",
            "packageDirectories": [{ "path": "force-app", "default": true }],
            "namespace": "",
            "sfdcLoginUrl": "https://login.salesforce.com",
            "sourceApiVersion": "60.0"
          }
          EOF

          cat > config/project-scratch-def.json << 'EOF'
          {
            "orgName": "Tech Solutions Inc",
            "edition": "Developer",
            "hasSampleData": false,
            "settings": {
              "lightningExperienceSettings": { "enableS1DesktopEnabled": true }
            }
          }
          EOF

          cat > README.md << 'EOF'
          # Tech Solutions App

          Manage devices, stock, and device orders. Includes automation, analytics, LWCs, and tests.

          ## Quickstart (Developer Org)
          1) Login + deploy
             - sf org login web -a GTP5org
             - sf project deploy start -o GTP5org
             - sf org assign permset -n TechSolutions_Admin -o GTP5org
          2) Seed data
             - sf apex run --file scripts/apex/data-seed.apex -o GTP5org
          3) Open app
             - sf org open -o GTP5org → App Launcher → Tech Solutions
          EOF

          echo "Project files created successfully!"
          SCRIPT_EOF
          
          chmod +x scripts/generate-project.sh
          
      - name: Commit and push files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat: bootstrap Tech Solutions SFDX app - basic structure"
            git push
          fi