name: Bootstrap Tech Solutions App

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      
      - name: Generate SFDX project structure
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Creating Tech Solutions SFDX app structure..."

          # Create directory structure
          mkdir -p config
          mkdir -p force-app/main/default/{applications,objects,classes,triggers,lwc,tabs,permissionsets}
          mkdir -p force-app/main/default/objects/Device__c/{fields,listViews}
          mkdir -p force-app/main/default/objects/Device_Order__c/{fields,validationRules}
          mkdir -p force-app/main/default/lwc/{inventoryDashboard,quickOrder}
          mkdir -p scripts/apex

          echo "Creating basic project files..."

          # Basic project files
          cat > .gitignore << 'EOF'
          .sfdx/
          .sf/
          .vscode/
          node_modules/
          coverage/
          test-results/
          package-lock.json
          yarn.lock
          EOF

          cat > .forceignore << 'EOF'
          **/tmp/**
          *.log
          .DS_Store
          EOF

          cat > sfdx-project.json << 'EOF'
          {
            "name": "tech-solutions",
            "packageDirectories": [{ "path": "force-app", "default": true }],
            "namespace": "",
            "sfdcLoginUrl": "https://login.salesforce.com",
            "sourceApiVersion": "60.0"
          }
          EOF

          cat > config/project-scratch-def.json << 'EOF'
          {
            "orgName": "Tech Solutions Inc",
            "edition": "Developer",
            "hasSampleData": false,
            "settings": {
              "lightningExperienceSettings": { "enableS1DesktopEnabled": true }
            }
          }
          EOF

          cat > README.md << 'EOF'
          # Tech Solutions App

          Complete Salesforce inventory management system with devices and orders.

          ## Quick Deploy to Developer Org

          ```bash
          # 1. Login to your org
          sf org login web -a GTP5org

          # 2. Deploy the app
          sf project deploy start -o GTP5org

          # 3. Assign permissions
          sf org assign permset -n TechSolutions_Admin -o GTP5org

          # 4. Seed sample data
          sf apex run --file scripts/apex/data-seed.apex -o GTP5org

          # 5. Open the app
          sf org open -o GTP5org
          ```

          Then navigate to App Launcher → Tech Solutions
          EOF

          echo "Project structure created successfully!"

      - name: Create sample Salesforce metadata
        run: |
          # Application
          cat > force-app/main/default/applications/Tech_Solutions.app-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomApplication xmlns="http://soap.sforce.com/2006/04/metadata">
            <description>Tech Solutions app for managing devices and orders</description>
            <label>Tech Solutions</label>
            <logo>none</logo>
            <navType>Standard</navType>
            <tabs>standard-Home</tabs>
            <tabs>Device__c</tabs>
            <tabs>Device_Order__c</tabs>
            <uiType>Lightning</uiType>
          </CustomApplication>
          EOF

          # Device Tab
          cat > force-app/main/default/tabs/Device__c.tab-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomTab xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Devices</label>
            <motif>Custom67: PDA</motif>
            <object>Device__c</object>
          </CustomTab>
          EOF

          # Device Order Tab
          cat > force-app/main/default/tabs/Device_Order__c.tab-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomTab xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device Orders</label>
            <motif>Custom88: Shopping Cart</motif>
            <object>Device_Order__c</object>
          </CustomTab>
          EOF

          # Device Object
          cat > force-app/main/default/objects/Device__c/Device__c.object-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device</label>
            <pluralLabel>Devices</pluralLabel>
            <nameField>
              <type>Text</type>
              <label>Device Name</label>
            </nameField>
            <deploymentStatus>Deployed</deploymentStatus>
            <sharingModel>ReadWrite</sharingModel>
            <description>Portable electronic devices for inventory management</description>
            <enableActivities>true</enableActivities>
          </CustomObject>
          EOF

          # Device Type Field
          cat > force-app/main/default/objects/Device__c/fields/Type__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Type__c</fullName>
            <label>Type</label>
            <type>Picklist</type>
            <valueSet>
              <valueSetDefinition>
                <sorted>false</sorted>
                <value><fullName>Laptop</fullName><default>false</default><label>Laptop</label></value>
                <value><fullName>Smartphone</fullName><default>false</default><label>Smartphone</label></value>
                <value><fullName>Tablet</fullName><default>false</default><label>Tablet</label></value>
              </valueSetDefinition>
            </valueSet>
          </CustomField>
          EOF

          # Stock Quantity Field
          cat > force-app/main/default/objects/Device__c/fields/Stock_Quantity__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Stock_Quantity__c</fullName>
            <label>Stock Quantity</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          # Price Field
          cat > force-app/main/default/objects/Device__c/fields/Price__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Price__c</fullName>
            <label>Price</label>
            <type>Currency</type>
            <precision>18</precision>
            <scale>2</scale>
          </CustomField>
          EOF

          # Active Field
          cat > force-app/main/default/objects/Device__c/fields/Active__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Active__c</fullName>
            <label>Active</label>
            <type>Checkbox</type>
            <defaultValue>true</defaultValue>
          </CustomField>
          EOF

          echo "Device object and fields created!"

      - name: Create Device Order object
        run: |
          # Device Order Object
          cat > force-app/main/default/objects/Device_Order__c/Device_Order__c.object-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device Order</label>
            <pluralLabel>Device Orders</pluralLabel>
            <nameField>
              <type>AutoNumber</type>
              <label>Order Number</label>
              <displayFormat>ORD-{0000}</displayFormat>
            </nameField>
            <deploymentStatus>Deployed</deploymentStatus>
            <sharingModel>ReadWrite</sharingModel>
            <description>Orders for Devices</description>
            <enableActivities>true</enableActivities>
          </CustomObject>
          EOF

          # Device Lookup Field
          cat > force-app/main/default/objects/Device_Order__c/fields/Device__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Device__c</fullName>
            <label>Device</label>
            <type>Lookup</type>
            <referenceTo>Device__c</referenceTo>
            <relationshipName>Orders</relationshipName>
            <relationshipLabel>Orders</relationshipLabel>
            <deleteConstraint>SetNull</deleteConstraint>
          </CustomField>
          EOF

          # Quantity Field
          cat > force-app/main/default/objects/Device_Order__c/fields/Quantity__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Quantity__c</fullName>
            <label>Quantity</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          # Status Field
          cat > force-app/main/default/objects/Device_Order__c/fields/Status__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Status__c</fullName>
            <label>Status</label>
            <type>Picklist</type>
            <valueSet>
              <valueSetDefinition>
                <sorted>false</sorted>
                <value><fullName>Draft</fullName><default>false</default><label>Draft</label></value>
                <value><fullName>Confirmed</fullName><default>true</default><label>Confirmed</label></value>
                <value><fullName>Fulfilled</fullName><default>false</default><label>Fulfilled</label></value>
                <value><fullName>Cancelled</fullName><default>false</default><label>Cancelled</label></value>
              </valueSetDefinition>
            </valueSet>
          </CustomField>
          EOF

          echo "Device Order object created!"

      - name: Create Permission Set
        run: |
          # Admin Permission Set
          cat > force-app/main/default/permissionsets/TechSolutions_Admin.permissionset-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <PermissionSet xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>TechSolutions Admin</label>
            <hasActivationRequired>false</hasActivationRequired>

            <objectPermissions>
              <object>Device__c</object>
              <allowCreate>true</allowCreate>
              <allowDelete>true</allowDelete>
              <allowEdit>true</allowEdit>
              <allowRead>true</allowRead>
              <modifyAllRecords>true</modifyAllRecords>
              <viewAllRecords>true</viewAllRecords>
            </objectPermissions>
            <objectPermissions>
              <object>Device_Order__c</object>
              <allowCreate>true</allowCreate>
              <allowDelete>true</allowDelete>
              <allowEdit>true</allowEdit>
              <allowRead>true</allowRead>
              <modifyAllRecords>true</modifyAllRecords>
              <viewAllRecords>true</viewAllRecords>
            </objectPermissions>
          </PermissionSet>
          EOF

          echo "Permission set created!"

      - name: Create sample data script
        run: |
          # Data seeding script
          cat > scripts/apex/data-seed.apex << 'EOF'
          // Create sample devices
          List<Device__c> devices = new List<Device__c>{
              new Device__c(Name='MacBook Pro', Type__c='Laptop', Stock_Quantity__c=25, Price__c=2499.00, Active__c=true),
              new Device__c(Name='iPhone 15', Type__c='Smartphone', Stock_Quantity__c=50, Price__c=999.00, Active__c=true),
              new Device__c(Name='iPad Air', Type__c='Tablet', Stock_Quantity__c=30, Price__c=599.00, Active__c=true),
              new Device__c(Name='Dell XPS 13', Type__c='Laptop', Stock_Quantity__c=15, Price__c=1299.00, Active__c=true),
              new Device__c(Name='Samsung Galaxy S24', Type__c='Smartphone', Stock_Quantity__c=40, Price__c=899.00, Active__c=true)
          };
          
          insert devices;
          
          System.debug('Sample devices created: ' + devices.size());
          
          // Create sample orders
          List<Device_Order__c> orders = new List<Device_Order__c>{
              new Device_Order__c(Device__c=devices[0].Id, Quantity__c=2, Status__c='Confirmed'),
              new Device_Order__c(Device__c=devices[1].Id, Quantity__c=5, Status__c='Confirmed'),
              new Device_Order__c(Device__c=devices[2].Id, Quantity__c=3, Status__c='Draft')
          };
          
          insert orders;
          
          System.debug('Sample orders created: ' + orders.size());
          System.debug('Tech Solutions sample data setup complete!');
          EOF

          echo "Sample data script created!"

      - name: Commit and push all files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat: bootstrap complete Tech Solutions SFDX app with objects, fields, and sample data"
            git push
          fi
          echo "✅ Bootstrap complete! The repository now contains a complete Salesforce app structure."