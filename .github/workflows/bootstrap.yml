name: Bootstrap Tech Solutions App

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      
      - name: Generate SFDX project
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          echo "Scaffolding Tech Solutions SFDX app..."

          mkdir -p config
          mkdir -p force-app/main/default/{applications,objects,classes,triggers,lwc,tabs,permissionsets}
          mkdir -p force-app/main/default/objects/Device__c/{fields,listViews}
          mkdir -p force-app/main/default/objects/Device_Order__c/{fields,validationRules}
          mkdir -p force-app/main/default/lwc/{inventoryDashboard,quickOrder}
          mkdir -p scripts/apex

          cat > .gitignore << 'EOF'
          .sfdx/
          .sf/
          .vscode/
          node_modules/
          coverage/
          test-results/
          package-lock.json
          yarn.lock
          EOF

          cat > .forceignore << 'EOF'
          **/tmp/**
          *.log
          .DS_Store
          EOF

          cat > sfdx-project.json << 'EOF'
          {
            "name": "tech-solutions",
            "packageDirectories": [{ "path": "force-app", "default": true }],
            "namespace": "",
            "sfdcLoginUrl": "https://login.salesforce.com",
            "sourceApiVersion": "60.0"
          }
          EOF

          cat > config/project-scratch-def.json << 'EOF'
          {
            "orgName": "Tech Solutions Inc",
            "edition": "Developer",
            "hasSampleData": false,
            "settings": {
              "lightningExperienceSettings": { "enableS1DesktopEnabled": true }
            }
          }
          EOF

          cat > README.md << 'EOF'
          # Tech Solutions App

          Manage devices, stock, and device orders. Includes automation, analytics, LWCs, and tests.

          ## Quickstart (Developer Org)
          1) Login + deploy
             - sf org login web -a GTP5org
             - sf project deploy start -o GTP5org
             - sf org assign permset -n TechSolutions_Admin -o GTP5org
          2) Seed data
             - sf apex run --file scripts/apex/data-seed.apex -o GTP5org
          3) Open app
             - sf org open -o GTP5org → App Launcher → Tech Solutions
          EOF

          # App
          cat > force-app/main/default/applications/Tech_Solutions.app-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomApplication xmlns="http://soap.sforce.com/2006/04/metadata">
            <description>Tech Solutions app for managing devices and orders</description>
            <label>Tech Solutions</label>
            <logo>none</logo>
            <navType>Standard</navType>
            <tabs>standard-Home</tabs>
            <tabs>Device__c</tabs>
            <tabs>Device_Order__c</tabs>
            <tabs>standard-Report</tabs>
            <tabs>standard-Dashboard</tabs>
            <uiType>Lightning</uiType>
          </CustomApplication>
          EOF

          # Tabs
          cat > force-app/main/default/tabs/Device__c.tab-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomTab xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Devices</label>
            <motif>Custom67: PDA</motif>
            <object>Device__c</object>
          </CustomTab>
          EOF

          cat > force-app/main/default/tabs/Device_Order__c.tab-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomTab xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device Orders</label>
            <motif>Custom88: Shopping Cart</motif>
            <object>Device_Order__c</object>
          </CustomTab>
          EOF

          # Device__c object (decomposed fields)
          cat > force-app/main/default/objects/Device__c/Device__c.object-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device</label>
            <pluralLabel>Devices</pluralLabel>
            <nameField>
              <type>Text</type>
              <label>Device Name</label>
            </nameField>
            <deploymentStatus>Deployed</deploymentStatus>
            <sharingModel>ReadWrite</sharingModel>
            <description>Portable electronic devices</description>
            <enableActivities>true</enableActivities>
          </CustomObject>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Type__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Type__c</fullName>
            <label>Type</label>
            <type>Picklist</type>
            <valueSet>
              <valueSetDefinition>
                <sorted>false</sorted>
                <value><fullName>Laptop</fullName><default>false</default><label>Laptop</label></value>
                <value><fullName>Smartphone</fullName><default>false</default><label>Smartphone</label></value>
                <value><fullName>Tablet</fullName><default>false</default><label>Tablet</label></value>
              </valueSetDefinition>
            </valueSet>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/SKU__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>SKU__c</fullName>
            <label>SKU</label>
            <type>Text</type>
            <length>50</length>
            <unique>true</unique>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Stock_Quantity__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Stock_Quantity__c</fullName>
            <label>Stock Quantity</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Price__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Price__c</fullName>
            <label>Price</label>
            <type>Currency</type>
            <precision>18</precision>
            <scale>2</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Reorder_Level__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Reorder_Level__c</fullName>
            <label>Reorder Level</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Reorder_Amount__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Reorder_Amount__c</fullName>
            <label>Reorder Amount</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Auto_Restock__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Auto_Restock__c</fullName>
            <label>Auto Restock</label>
            <type>Checkbox</type>
            <defaultValue>true</defaultValue>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Active__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Active__c</fullName>
            <label>Active</label>
            <type>Checkbox</type>
            <defaultValue>true</defaultValue>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Image_URL__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Image_URL__c</fullName>
            <label>Image URL</label>
            <type>Url</type>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/fields/Is_Low_Stock__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Is_Low_Stock__c</fullName>
            <label>Low Stock</label>
            <type>Checkbox</type>
            <formula>AND(NOT(ISBLANK(Reorder_Level__c)), Stock_Quantity__c &lt;= Reorder_Level__c)</formula>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device__c/listViews/Low_Stock.listView-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <ListView xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Low_Stock</fullName>
            <label>Low Stock</label>
            <filterScope>Everything</filterScope>
            <columns>NAME</columns>
            <columns>Type__c</columns>
            <columns>Stock_Quantity__c</columns>
            <columns>Reorder_Level__c</columns>
            <filters>
              <field>Is_Low_Stock__c</field>
              <operation>equals</operation>
              <value>1</value>
            </filters>
          </ListView>
          EOF

          # Device_Order__c object + fields
          cat > force-app/main/default/objects/Device_Order__c/Device_Order__c.object-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomObject xmlns="http://soap.sforce.com/2006/04/metadata">
            <label>Device Order</label>
            <pluralLabel>Device Orders</pluralLabel>
            <nameField>
              <type>AutoNumber</type>
              <label>Order Number</label>
              <displayFormat>ORD-{0000}</displayFormat>
            </nameField>
            <deploymentStatus>Deployed</deploymentStatus>
            <sharingModel>ReadWrite</sharingModel>
            <description>Orders for Devices (custom to avoid standard Order conflicts)</description>
            <enableActivities>true</enableActivities>
          </CustomObject>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/Device__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Device__c</fullName>
            <label>Device</label>
            <type>Lookup</type>
            <referenceTo>Device__c</referenceTo>
            <relationshipName>Orders</relationshipName>
            <relationshipLabel>Orders</relationshipLabel>
            <deleteConstraint>SetNull</deleteConstraint>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/Quantity__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Quantity__c</fullName>
            <label>Quantity</label>
            <type>Number</type>
            <precision>18</precision>
            <scale>0</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/Status__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Status__c</fullName>
            <label>Status</label>
            <type>Picklist</type>
            <valueSet>
              <valueSetDefinition>
                <sorted>false</sorted>
                <value><fullName>Draft</fullName><default>false</default><label>Draft</label></value>
                <value><fullName>Confirmed</fullName><default>true</default><label>Confirmed</label></value>
                <value><fullName>Fulfilled</fullName><default>false</default><label>Fulfilled</label></value>
                <value><fullName>Cancelled</fullName><default>false</default><label>Cancelled</label></value>
              </valueSetDefinition>
            </valueSet>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/Unit_Price__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Unit_Price__c</fullName>
            <label>Unit Price</label>
            <type>Currency</type>
            <precision>18</precision>
            <scale>2</scale>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/TotalPrice__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>TotalPrice__c</fullName>
            <label>Total Price</label>
            <type>Currency</type>
            <precision>18</precision>
            <scale>2</scale>
            <formula>BLANKVALUE(Quantity__c, 0) * BLANKVALUE(Unit_Price__c, 0)</formula>
            <formulaTreatBlankAs>BlankAsZero</formulaTreatBlankAs>
          </CustomField>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/fields/Notes__c.field-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <CustomField xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Notes__c</fullName>
            <label>Notes</label>
            <type>LongTextArea</type>
            <visibleLines>3</visibleLines>
            <length>32768</length>
          </CustomField>
          EOF

          # Validation rules
          cat > force-app/main/default/objects/Device_Order__c/validationRules/Require_Device_and_Quantity.validationRule-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Require_Device_and_Quantity</fullName>
            <active>true</active>
            <errorConditionFormula>OR(ISBLANK(Device__c), ISBLANK(Quantity__c))</errorConditionFormula>
            <errorDisplayLocation>TopOfPage</errorDisplayLocation>
            <errorMessage>Device and Quantity are required.</errorMessage>
          </ValidationRule>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/validationRules/Quantity_Must_Be_Positive.validationRule-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Quantity_Must_Be_Positive</fullName>
            <active>true</active>
            <errorConditionFormula>Quantity__c &lt;= 0</errorConditionFormula>
            <errorDisplayLocation>TopOfPage</errorDisplayLocation>
            <errorMessage>Quantity must be greater than zero.</errorMessage>
          </ValidationRule>
          EOF

          cat > force-app/main/default/objects/Device_Order__c/validationRules/Lock_Unit_Price_After_Create.validationRule-meta.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <ValidationRule xmlns="http://soap.sforce.com/2006/04/metadata">
            <fullName>Lock_Unit_Price_After_Create</fullName>
            <active>true</active>
            <errorConditionFormula>AND(NOT(ISNEW()), Unit_Price__c &lt;&gt; PRIORVALUE(Unit_Price__c))</errorConditionFormula>
            <errorDisplayLocation>TopOfPage</errorDisplayLocation>
            <errorMessage>Unit Price cannot be changed after creation.</errorMessage>
          </ValidationRule>
          EOF

          # Continue with remaining files in the next step...
          echo "Bootstrap workflow updated - continuing with remaining files..."

      - name: Commit and push files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "feat: bootstrap Tech Solutions SFDX app"
            git push
          fi